"use strict";(function(){"use strict";const c=window.SteamDB,J=!!document.querySelector(".header-user-avatar");let W=J?300:900;const de=J?175:300,p=document.querySelector(".hover_wrapper");if(!p)return;const i=p.querySelector("#js-hover");if(!i||!c)return;const C=new Map;let A=null,f=null,b=null,m=null,H=null,K=!0,x=null,g=null;const h=document.querySelector("#js-screenshots"),z=document.body.dataset.storeAssets,q=new Image;q.fetchPriority="low";let a=null,O=0,v=0,Z=!1;c.RequirePageScreenshotViewer(ce,!0),he(),p.addEventListener("click",ue),i.addEventListener("pointerenter",me,{passive:!0}),i.addEventListener("pointerleave",ge,{passive:!0}),document.body.addEventListener("touchstart",fe,{passive:!0}),c.BindHover=e=>re(e.querySelectorAll(".app")),c.HideHoverIfAny=u,c.OnExtensionUserdataLoaded(()=>{K=!1});function ue(e){e.target instanceof Element&&e.target.classList.contains("hover_mobile")&&ne(i)}let y=null,w=null,d=null,k=!1,_=!1,ee=0;function fe(e){if(e.touches.length!==1||!(e.target instanceof HTMLElement))return;const t=e.target.closest(".app, #js-hover");if(t){if(k=t.id==="js-hover",_=!1,k){if(i.scrollTop>0)return;ee=Date.now(),t.classList.add("hover_dragging")}else{const n=oe(t,0);if(n!==null&&n.scrollLeft!==0)return}d=t,y=w=e.touches.item(0),document.body.addEventListener("touchmove",te,{passive:!0}),document.body.addEventListener("touchend",I,{passive:!0})}}function te(e){const t=e.touches.item(0),n=t.screenX-y.screenX,o=t.screenY-y.screenY;if(k){if(w=t,_||i.scrollTop>0){_=!0,y=t;return}d.style.transform=`translate3d(0, ${Math.max(0,o)}px, 0)`;return}if(t.screenX<w.screenX||Math.abs(o/n)>=.3){d=null,I();return}w=t}function I(){if(document.body.removeEventListener("touchmove",te),document.body.removeEventListener("touchend",I),d!==null){if(k){d.classList.remove("hover_dragging");const e=w.screenY-y.screenY,t=i.offsetHeight,n=Date.now()-ee,o=e/n;e>t/3||o>.5?ne(d):d.style.transform="";return}if(w.screenX-y.screenX>100){const e=+d.dataset.appid,t=C.get(e);if(p.classList.add("hover_mobile"),document.documentElement.classList.add("js-hover-shown"),"CloseWatcher"in window&&(x=new window.CloseWatcher,x.addEventListener("close",()=>u(!0))),t){i.appendChild(t),M(t,null);return}ie(e,null)}d=null}}function ne(e){if(e.hidden){u(!0);return}p.classList.add("hover_hiding"),e.addEventListener("transitionend",()=>u(),{once:!0}),e.style.transform=`translate3d(0, ${Math.max(0,e.offsetHeight)}px, 0)`}function oe(e,t){return e===null||t>8?null:e.scrollWidth>e.clientWidth?e:oe(e.parentElement,t+1)}function he(){const e=typeof $=="function"&&typeof $.fn=="object"&&typeof $.fn.dataTable=="function";let t=e?[]:document.querySelectorAll(".app");e&&$($.fn.dataTable.tables()).each(function(){const n=$(this).DataTable().table();t=Array.from(n.rows(".app").nodes()),$(this).on("draw.dt",()=>u())}),re(t)}function re(e){for(const t of e)t.addEventListener("pointerenter",se,{passive:!0}),t.addEventListener("pointerleave",ve,{passive:!0})}function se(e){const t=e.target;if(e.pointerType!=="mouse"||!(t instanceof HTMLElement)||window.matchMedia("(max-width: 979px)").matches)return;if(f){b=e;return}const n=+t.dataset.appid,o=C.get(n);if(o){i.appendChild(o),M(o,t);return}u(),A=setTimeout(()=>{ie(n,t)},W)}function ie(e,t){if(m=new AbortController,fetch(`/api/RenderAppHover/?appid=${e}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"},signal:m.signal}).then(n=>{if(!n.ok){n.status>=400&&n.status!==404&&(W=5e3);const o=new Error(`HTTP ${n.status}`);throw o.name="ServerError",o}return n.text()}).then(n=>{m=null,W=de,i.insertAdjacentHTML("beforeend",n);const o=i.lastElementChild;if(o instanceof HTMLElement){C.set(e,o),ye(e,o);const r=o.querySelector(".js-open-screenshot-viewer");if(r&&r.dataset.screenshots){const s=r.dataset.screenshots.split(","),l=o.querySelector(".hover_title").textContent;ce(+r.dataset.appid,l,r,s)}M(o,t)}}).catch(n=>{if(n.name!=="AbortError"&&(u(!0),n.name!=="ServerError"))throw n}),!Z){Z=!0;const n=document.createElement("link");n.rel="preconnect",n.href=document.body.dataset.videoCdn,document.head.append(n)}}function u(e=!1){if(b=null,A&&(clearTimeout(A),A=null),f&&(clearTimeout(f),f=null),m&&(m.abort(),m=null),x&&(x.destroy(),x=null),H){i.scrollTop=0,i.hidden=!0,i.style.transform="";const t=H.querySelector("video");t&&t.remove(),H.remove(),H=null,e=!0}e&&(p.classList.remove("hover_mobile","hover_hiding"),document.documentElement.classList.remove("js-hover-shown"))}function ve(e){e.pointerType==="mouse"&&(b=null,!f&&(e.relatedTarget instanceof Element&&i.contains(e.relatedTarget)||(f=setTimeout(pe,100))))}function pe(){const e=b;u(),e&&se(e)}function me(){clearTimeout(f),f=null,b=null}function ge(e){e.pointerType==="mouse"&&u()}function M(e,t){H=e;const n=e.querySelector(".hover_video"),o=n?.dataset.microtrailer;if(o){const L=document.createElement("video");L.autoplay=!0,L.muted=!0,L.loop=!0,L.playsInline=!0;const Le=document.body.dataset.videoCdn,ae=JSON.parse(o);for(const[be,He]of Object.entries(ae.video)){const G=document.createElement("source");G.type=be,G.src=`${Le}store_trailers/${He}?t=${ae.time}`,L.append(G)}n.appendChild(L)}if(i.hidden=!1,t===null)return;const r=t.getBoundingClientRect(),s=document.documentElement.scrollTop,l=r.top+s,we=r.bottom+s,F=r.left+document.documentElement.scrollLeft,Se=document.documentElement.clientWidth,Y=document.documentElement.clientHeight,V=i.offsetWidth,T=i.offsetHeight,Ee=Se-(F+r.width+V),N=F-V;let E=0,D="0",Q="0";N<0&&Ee<0?(D=r.right-V+"px",l+T>Y+s&&l-T>=s?E=l-T:E=we):(N<0?D=F+r.width+"px":D=N+"px",l+T>Y+s?E=Y+s-T:E=l),E<1?Q="0":Q=E+"px",i.style.transform=`translate3d(${D}, ${Q}, 0)`}function S(e){v+=e,v<0?v=a.length-1:v%=a.length;let t=a[v];if(t.startsWith("https://")||(t=`${z}apps/${O}/${t}`),h.querySelector(".screenshot-contain").style.backgroundImage=`url(${encodeURI(t)})`,h.querySelector(".screenshot-index").textContent=`${v+1} of ${a.length}`,h.querySelector(".screenshot-open").href=t,a.length>1){e===0&&(e=1);let n=v+e;n<0?n=a.length-1:n%=a.length,t=a[n],t.startsWith("https://")||(t=`${z}apps/${O}/${t}`),q.src=t}}function le(e){e.key==="ArrowLeft"?(e.preventDefault(),S(-1)):e.key==="ArrowRight"||e.key===" "?(e.preventDefault(),S(1)):e.key==="Escape"&&g===null&&(e.preventDefault(),j())}function j(){document.documentElement.classList.remove("js-screenshots-shown"),document.removeEventListener("keydown",le),a=null,q.src="data:,",g&&(g.destroy(),g=null)}h.querySelector(".screenshot-prev").addEventListener("click",e=>{e.preventDefault(),S(-1)}),h.querySelector(".screenshot-next").addEventListener("click",e=>{e.preventDefault(),S(1)}),h.querySelector(".screenshot-close").addEventListener("click",e=>{e.preventDefault(),j()}),h.querySelector(".screenshot-contain").addEventListener("click",e=>{e.preventDefault(),S(e.pageX/document.documentElement.clientWidth>=.5?1:-1)});function ce(e,t,n,o){const r=s=>{const l=h.querySelector(".screenshot-name");l.textContent=`SteamDB \u2014 ${t}`,l.href=`/app/${e}/`,v=s,O=e,a=o,S(0),document.documentElement.classList.add("js-screenshots-shown"),document.addEventListener("keydown",le),"CloseWatcher"in window&&(g=new window.CloseWatcher,g.addEventListener("close",j))};return n&&n.addEventListener("click",s=>{s.preventDefault(),r(0)}),{open:r}}function ye(e,t){if(K)return;const n=t.querySelector(".hover_wishlist"),o=t.querySelector(".hover_follow"),r=t.querySelector(".hover_ignore"),s=t.querySelector(".hover_owned");c.OwnedApps.has(e)?s.hidden=!1:(c.FamilySharedApps.has(e)&&(s.textContent="In Family Library",s.classList.add("infamily"),s.hidden=!1),n&&(c.WishedApps.has(e)&&P(n,!0),n.hidden=!1,n.addEventListener("click",l=>{l.preventDefault(),B(n),R(e,c.WishedApps.has(e)?"StoreWishlistRemove":"StoreWishlistAdd")}))),o&&(c.FollowedApps.has(e)&&U(o,!0),o.hidden=!1,o.addEventListener("click",l=>{l.preventDefault(),B(o),R(e,c.FollowedApps.has(e)?"StoreUnfollow":"StoreFollow")})),r&&(c.IgnoredApps.has(e)&&X(r,!0),r.hidden=!1,r.addEventListener("click",l=>{l.preventDefault(),B(r),R(e,c.IgnoredApps.has(e)?"StoreUnignore":"StoreIgnore")}))}function B(e){e.innerHTML='<span class="loader"></span>'}function R(e,t){window.postMessage({type:"steamdb:extension-query",contentScriptQuery:t,appid:e},window.location.origin)}function P(e,t){e&&(e.classList.toggle("wished",t),e.textContent=t?"On Wishlist":"Wishlist")}function U(e,t){e&&(e.classList.toggle("followed",t),e.textContent=t?"Unfollow":"Follow")}function X(e,t){e&&(e.classList.toggle("ignored",t),e.textContent=t?"Unignore":"Ignore")}if("BroadcastChannel"in window)try{new BroadcastChannel("steamdb-extension").addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success||!t.data.request.appid)return;const n=C.get(t.data.request.appid);if(!n)return;const o=n.querySelector(".hover_wishlist"),r=n.querySelector(".hover_follow"),s=n.querySelector(".hover_ignore");switch(t.data.request.contentScriptQuery){case"StoreWishlistAdd":P(o,!0);break;case"StoreWishlistRemove":P(o,!1);break;case"StoreFollow":U(r,!0);break;case"StoreUnfollow":U(r,!1);break;case"StoreIgnore":X(s,!0);break;case"StoreUnignore":X(s,!1);break}}})}catch{}})();
