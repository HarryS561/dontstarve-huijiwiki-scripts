"use strict";(function(){"use strict";const f=window.SteamDB,w=navigator.webdriver||/bot|spider/i.test(navigator.userAgent);let u=0,p=0;const m=document.querySelector(".history-container"),n=document.querySelector("#js-history-load"),b=document.querySelector(".history-filters-container"),S=document.querySelector("#js-filter-history-load"),h=document.querySelector("#js-filter-history-key"),d=document.querySelector("#js-filter-history-date"),L=document.querySelector("#js-history-loading"),v=new window.diff_match_patch,k=function(e){e.forEach(t=>{const a=t.querySelector("del").textContent,r=t.querySelector("ins").textContent,o=v.diff_main(a,r);v.diff_cleanupSemantic(o),v.diff_cleanupEfficiency(o),t.title=`${a} \u2192
${r}`,t.replaceChildren(v.diff_generateHtmlFragment(o))})};if(S&&S.addEventListener("click",function(){this.disabled=!0,this.textContent="Loading\u2026";let e;switch(n.dataset.scope){case"app":e=`appid=${n.dataset.appid}`;break;case"sub":e=`subid=${n.dataset.subid}`;break}fetch(`/api/GetHistoryFilters/?${e}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(t=>{if(!t.ok){const a=new Error(`HTTP ${t.status}`);throw a.name="ServerError",a}return t.json()}).then(t=>{if(S.hidden=!0,t&&t.success){for(const a of t.data){const r=document.createElement("option");r.value=a.Key.toString(),r.textContent=a.Name,h.appendChild(r),u===a.Key&&(r.selected=!0)}h.hidden=!1}}).catch(t=>{throw S.textContent="Failed to load history filters",f.Alert("Failed to load history filters: "+t),t})},{once:!0}),h){h.addEventListener("change",function(){p=0,u=Number.parseInt(this.value,10),m.replaceChildren(),y();const t=new URLSearchParams(location.search);u>0?t.set("filterkey",u.toString()):t.delete("filterkey"),history.replaceState(null,null,Array.from(t).length?`${location.pathname}?${t}`:location.pathname)});const e=new URLSearchParams(location.search);if(e.has("filterkey"))if(u=parseInt(e.get("filterkey"),10)||0,S)S.click();else{const t=h.querySelector(`option[value="${u}"]`);t&&(t.selected=!0)}}d&&(d.max=new Date().toISOString().substring(0,10),document.querySelector("#js-filter-history-date-load").addEventListener("click",e=>{e.preventDefault(),d.checkValidity()&&(p=0,m.replaceChildren(),y())}),document.querySelector("#js-filter-history-date-reset").addEventListener("click",e=>{e.preventDefault(),p=0,d.value=null,m.replaceChildren(),y()}),document.querySelector("#js-filter-history-date-toggle").addEventListener("click",e=>{e.preventDefault();const t=document.querySelector(".history-filter-date");t.hidden=!t.hidden,t.hidden?d.value=null:d.focus()})),n&&(n.addEventListener("click",()=>{n.disabled||y()}),document.getElementById("js-history-back").addEventListener("click",function(e){e.preventDefault(),history.replaceState(null,null,this.href),p=0,delete n.dataset.changeid,b&&(b.hidden=!1),document.getElementById("js-history-header-single").hidden=!0;const t=document.getElementById("js-history-header-all");t.hidden=!1,t.scrollIntoView({behavior:"smooth",block:"nearest"}),m.replaceChildren(),y()}));function q(e){if(document.body.classList.contains("page-history")||document.body.classList.contains("page-changelist"))return;e.preventDefault(),document.getElementById("js-history-back").href=location.href,history.replaceState(null,null,this.href);const t=new URL(this.href),a=new URLSearchParams(t.search);n.dataset.changeid=a.get("changeid"),p=0,b&&(b.hidden=!0),document.getElementById("js-history-header-all").hidden=!0;const r=document.getElementById("js-history-header-single");r.querySelector("b").textContent=a.get("changeid"),r.hidden=!1,r.scrollIntoView({behavior:"smooth",block:"nearest"}),m.replaceChildren(),y()}function y(){h&&(h.disabled=!0),d&&(d.disabled=!0),L.hidden=!1,n.disabled=!0,n.classList.add("app-history-loading"),n.parentElement.hidden=!1;const e=new URLSearchParams;e.append("lastentry",p.toString()),n.dataset.changeid?e.append("changeid",n.dataset.changeid):(u>0&&e.append("key",u.toString()),p===0&&d&&d.value&&e.append("before",d.value));const t=(r,o,i)=>{if(n.disabled=!1,n.classList.remove("app-history-loading"),h&&(h.disabled=!1),d&&(d.disabled=!1),o===0){n.parentElement.hidden=!0;return}const s=document.createElement("div");s.innerHTML=r;const c=s.querySelector(".panel-history:first-child");if(c){const g=m.querySelector('.panel-history[data-changeid="'+c.dataset.changeid+'"]');g&&(g.querySelector(".app-history").append(...c.querySelector(".app-history").childNodes),c.remove())}if(k(s.querySelectorAll(".diff")),H(s),f.EnhanceLazyLoadedApps&&(f.EnhanceLazyLoadedApps(s),f.EnhanceLazyLoadedPackages(s)),"BindImageHover"in f){const g=s.querySelectorAll(".image-hover");g.length>0&&f.BindImageHover(g)}const l=s.querySelectorAll(".app-history-permalink");for(const g of l)g.addEventListener("click",q);m.append(...s.childNodes),L.hidden=!0,i?o===-1?(n.disabled=!0,n.hidden=!0,document.getElementById("js-history-signin").hidden=!1):p=o:n.parentElement.hidden=!0},a=(r,o)=>{fetch(`/api/${r}/?${o.toString()}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}}).then(i=>{if(!i.ok){const l=new Error(`HTTP ${i.status}`);throw l.name="ServerError",l}const s=i.headers.get("X-SteamDB-History-LastChangeID"),c=i.headers.get("X-SteamDB-History-More");if(s===null){const l=new Error("No history was returned.");throw l.name="ServerError",l}i.text().then(l=>t(l,parseInt(s,10),c==="yes"))}).catch(i=>{if(n.parentElement.hidden=!0,f.Alert("Failed to load history: "+i),i.name!=="ServerError")throw i})};switch(n.dataset.scope){case"app":e.append("appid",n.dataset.appid),a("GetAppHistory",e);break;case"sub":e.append("subid",n.dataset.subid),a("GetSubHistory",e);break;case"depot":e.append("depotid",n.dataset.depotid),a("GetDepotHistory",e);break;case"bundle":e.append("bundleid",n.dataset.bundleid),a("GetBundleHistory",e);break;case"appsub":{e.append("appid",n.dataset.appid),a("GetAppHistory",e),e.delete("appid"),e.append("subid",n.dataset.subid),a("GetSubHistory",e);return}default:throw new Error("Unknown history scope")}}if(n&&!w){let e=0;const t=new window.IntersectionObserver(a=>{a.forEach(r=>{r.isIntersecting&&(e++>2&&t.unobserve(n),n.disabled||y())})},{root:null});t.observe(n)}function H(e){const t=e.querySelectorAll(".panel-history");for(const a of t)if(a.querySelectorAll(".image-hover").length>0){const o=a.querySelector(".panel-heading span");if(o&&!o.querySelector(".js-history-load-images")){const i=document.createElement("button");i.className="btn btn-outline js-history-load-images",i.textContent="Show images",i.addEventListener("click",()=>{i.remove(),j(a)}),o.insertAdjacentElement("afterend",i)}}}function j(e){const t=e.querySelectorAll(".image-hover"),a=new Map;for(const r of t){const o=r.closest("li");if(o){const i=a.get(o);i?i.push(r):a.set(o,[r])}}for(const[r,o]of a){const i=document.createElement("li");i.className="history-inline-image",o.forEach(s=>{const c=document.createElement("img");c.alt="",c.src=s.dataset.src||s.href,c.referrerPolicy="no-referrer";const l=document.createElement("div");l.append(c),i.append(l)}),r.insertAdjacentElement("afterend",i)}}const E=document.querySelector("#js-history-heatmap-toggle");if(E){const e=document.querySelector("#js-history-heatmap-container");let t=!1;E.addEventListener("click",async function(){if(!e.hidden){e.hidden=!0;return}if(!t){t=!0,E.disabled=!0;try{const a=new URLSearchParams;a.append("appid",n.dataset.appid);const r=await fetch(`/api/GetAppHistoryHeatmap/?${a}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!r.ok)throw new Error(`HTTP ${r.status}`);const o=await r.text();e.innerHTML=o,e.querySelectorAll(".js-heatmap-day").forEach(s=>{s.addEventListener("click",c=>{c.preventDefault();const l=document.querySelector(".history-filter-date");l.hidden=!1,d.value=s.dataset.date,d.focus()})})}catch(a){e.textContent=`\u26A0 Failed to load heatmap: ${a}`,console.error(a)}E.disabled=!1}e.hidden=!1})}})();
