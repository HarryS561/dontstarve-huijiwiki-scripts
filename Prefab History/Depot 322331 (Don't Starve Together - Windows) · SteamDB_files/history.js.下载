"use strict";(function(){"use strict";const p=window.SteamDB,k=navigator.webdriver||/bot|spider/i.test(navigator.userAgent);let u=0,f=0;const y=document.querySelector(".history-container"),n=document.querySelector("#js-history-load"),b=document.querySelector(".history-filters-container"),S=document.querySelector("#js-filter-history-load"),h=document.querySelector("#js-filter-history-key"),d=document.querySelector("#js-filter-history-date"),E=document.querySelector("#js-history-loading"),v=new window.diff_match_patch,w=function(e){e.forEach(t=>{const r=t.querySelector("del").textContent,a=t.querySelector("ins").textContent,o=v.diff_main(r,a);v.diff_cleanupSemantic(o),v.diff_cleanupEfficiency(o),t.title=`${r} \u2192
${a}`,t.replaceChildren(v.diff_generateHtmlFragment(o))})};if(S&&S.addEventListener("click",function(){this.disabled=!0,this.textContent="Loading\u2026";let e;switch(n.dataset.scope){case"app":e=`appid=${n.dataset.appid}`;break;case"sub":e=`subid=${n.dataset.subid}`;break}fetch(`/api/GetHistoryFilters/?${e}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}).then(t=>{if(!t.ok){const r=new Error(`HTTP ${t.status}`);throw r.name="ServerError",r}return t.json()}).then(t=>{if(S.hidden=!0,t&&t.success){for(const r of t.data){const a=document.createElement("option");a.value=r.Key.toString(),a.textContent=r.Name,h.appendChild(a),u===r.Key&&(a.selected=!0)}h.hidden=!1}}).catch(t=>{throw S.textContent="Failed to load history filters",p.Alert("Failed to load history filters: "+t),t})},{once:!0}),h){h.addEventListener("change",function(){f=0,u=Number.parseInt(this.value,10),y.replaceChildren(),m();const t=new URLSearchParams(location.search);u>0?t.set("filterkey",u.toString()):t.delete("filterkey"),history.replaceState(null,null,Array.from(t).length?`${location.pathname}?${t}`:location.pathname)});const e=new URLSearchParams(location.search);if(e.has("filterkey"))if(u=parseInt(e.get("filterkey"),10)||0,S)S.click();else{const t=h.querySelector(`option[value="${u}"]`);t&&(t.selected=!0)}}d&&(d.max=new Date().toISOString().substring(0,10),document.querySelector("#js-filter-history-date-load").addEventListener("click",e=>{e.preventDefault(),d.checkValidity()&&(f=0,y.replaceChildren(),m())}),document.querySelector("#js-filter-history-date-reset").addEventListener("click",e=>{e.preventDefault(),f=0,d.value=null,y.replaceChildren(),m()}),document.querySelector("#js-filter-history-date-toggle").addEventListener("click",e=>{e.preventDefault();const t=document.querySelector(".history-filter-date");t.hidden=!t.hidden,t.hidden?d.value=null:d.focus()})),n&&(n.addEventListener("click",()=>{n.disabled||m()}),document.getElementById("js-history-back").addEventListener("click",function(e){e.preventDefault(),history.replaceState(null,null,this.href),f=0,delete n.dataset.changeid,b&&(b.hidden=!1),document.getElementById("js-history-header-single").hidden=!0;const t=document.getElementById("js-history-header-all");t.hidden=!1,t.scrollIntoView({behavior:"smooth",block:"nearest"}),y.replaceChildren(),m()}));function L(e){if(document.body.classList.contains("page-history")||document.body.classList.contains("page-changelist"))return;e.preventDefault(),document.getElementById("js-history-back").href=location.href,history.replaceState(null,null,this.href);const t=new URL(this.href),r=new URLSearchParams(t.search);n.dataset.changeid=r.get("changeid"),f=0,b&&(b.hidden=!0),document.getElementById("js-history-header-all").hidden=!0;const a=document.getElementById("js-history-header-single");a.querySelector("b").textContent=r.get("changeid"),a.hidden=!1,a.scrollIntoView({behavior:"smooth",block:"nearest"}),y.replaceChildren(),m()}function m(){h&&(h.disabled=!0),d&&(d.disabled=!0),E.hidden=!1,n.disabled=!0,n.classList.add("app-history-loading"),n.parentElement.hidden=!1;const e=new URLSearchParams;e.append("lastentry",f.toString()),n.dataset.changeid?e.append("changeid",n.dataset.changeid):(u>0&&e.append("key",u.toString()),f===0&&d&&d.value&&e.append("before",d.value));const t=(a,o,i)=>{if(n.disabled=!1,n.classList.remove("app-history-loading"),h&&(h.disabled=!1),d&&(d.disabled=!1),o===0){n.parentElement.hidden=!0;return}const s=document.createElement("div");s.innerHTML=a;const c=s.querySelector(".panel-history:first-child");if(c){const g=y.querySelector('.panel-history[data-changeid="'+c.dataset.changeid+'"]');g&&(g.querySelector(".app-history").append(...c.querySelector(".app-history").childNodes),c.remove())}if(w(s.querySelectorAll(".diff")),q(s),p.EnhanceLazyLoadedApps&&(p.EnhanceLazyLoadedApps(s),p.EnhanceLazyLoadedPackages(s)),"BindImageHover"in p){const g=s.querySelectorAll(".image-hover");g.length>0&&p.BindImageHover(g)}const l=s.querySelectorAll(".app-history-permalink");for(const g of l)g.addEventListener("click",L);y.append(...s.childNodes),E.hidden=!0,i?o===-1?(n.disabled=!0,n.hidden=!0,document.getElementById("js-history-signin").hidden=!1):f=o:n.parentElement.hidden=!0},r=(a,o)=>{fetch(`/api/${a}/?${o.toString()}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}}).then(i=>{if(!i.ok){const l=new Error(`HTTP ${i.status}`);throw l.name="ServerError",l}const s=i.headers.get("X-SteamDB-History-LastChangeID"),c=i.headers.get("X-SteamDB-History-More");if(s===null){const l=new Error("No history was returned.");throw l.name="ServerError",l}i.text().then(l=>t(l,parseInt(s,10),c==="yes"))}).catch(i=>{if(n.parentElement.hidden=!0,p.Alert("Failed to load history: "+i),i.name!=="ServerError")throw i})};switch(n.dataset.scope){case"app":e.append("appid",n.dataset.appid),r("GetAppHistory",e);break;case"sub":e.append("subid",n.dataset.subid),r("GetSubHistory",e);break;case"depot":e.append("depotid",n.dataset.depotid),r("GetDepotHistory",e);break;case"bundle":e.append("bundleid",n.dataset.bundleid),r("GetBundleHistory",e);break;case"appsub":{e.append("appid",n.dataset.appid),r("GetAppHistory",e),e.delete("appid"),e.append("subid",n.dataset.subid),r("GetSubHistory",e);return}default:throw new Error("Unknown history scope")}}if(n&&!k){let e=0;const t=new window.IntersectionObserver(r=>{r.forEach(a=>{a.isIntersecting&&(e++>2&&t.unobserve(n),n.disabled||m())})},{root:null});t.observe(n)}function q(e){const t=e.querySelectorAll(".panel-history");for(const r of t)if(r.querySelectorAll(".image-hover").length>0){const o=r.querySelector(".panel-heading span");if(o&&!o.querySelector(".js-history-load-images")){const i=document.createElement("button");i.className="btn btn-outline js-history-load-images",i.textContent="Show images",i.addEventListener("click",()=>{i.remove(),H(r)}),o.insertAdjacentElement("afterend",i)}}}function H(e){const t=e.querySelectorAll(".image-hover"),r=new Map;for(const a of t){const o=a.closest("li");if(o){const i=r.get(o);i?i.push(a):r.set(o,[a])}}for(const[a,o]of r){const i=document.createElement("li");i.className="history-inline-image",o.forEach(s=>{const c=document.createElement("img");c.alt="",c.src=s.dataset.src||s.href,c.referrerPolicy="no-referrer";const l=document.createElement("div");l.append(c),i.append(l)}),a.insertAdjacentElement("afterend",i)}}})();
